<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Доброе утро — пиксельная магия</title>
  <meta name="description" content="Мини‑сайт с пиксельной лягушкой‑волшебницей, утренним пейзажем и предсказаниями." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --ink:#0f0f12; --muted:#7a7a86; --paper:#fff6d5; --paper-edge:#2b2b2b;
      --btn:#2E0F57; --btn-ink:#fff; --btn-active:#BEFA19;
      --glass: rgba(255,255,255,.7);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#0f0f12;color:#fff;overflow:hidden}
    canvas{position:fixed;inset:0;z-index:0;image-rendering: pixelated;}

    /* UI */
    .wrap{position:relative;z-index:1;height:100%;pointer-events:none}
    .hud{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;padding:24px;gap:16px}
    .bubble{pointer-events:auto;max-width:min(860px,95vw);background:var(--glass);backdrop-filter: blur(6px);border-radius:18px;padding:16px 18px;box-shadow:0 10px 30px rgba(0,0,0,.25);}
    .bubble h1{margin:0;font-family:"Press Start 2P", system-ui; font-size:clamp(16px,3.4vw,24px);line-height:1.4;color:#1a1a1a;text-shadow:0 1px 0 #fff}
    .controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .btn{pointer-events:auto;appearance:none;border:none;background:var(--btn);color:var(--btn-ink);padding:12px 16px;border-radius:12px;font-weight:700;cursor:pointer;transition:transform .05s ease, background .15s ease,color .15s ease}
    .btn:active{background:var(--btn-active); color:#111; transform:translateY(1px)}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .meta{opacity:.8;font-size:12px}

    /* Pixel paper */
    .paper{position:absolute;left:50%;top:18%;transform:translateX(-50%);max-width:min(720px,92vw);display:none;z-index:2}
    .paper-inner{position:relative;background:var(--paper); color:#1e1a12; padding:20px 24px; font-family:"Press Start 2P", system-ui; line-height:1.6; font-size:14px}
    .paper-inner:before, .paper-inner:after{content:"";position:absolute;inset:0;border:4px solid var(--paper-edge);pointer-events:none}
    .paper-grid{position:absolute;inset:6px;border:4px solid #704214; pointer-events:none}
    .paper-footer{display:flex;justify-content:space-between;gap:8px;align-items:center;margin-top:10px}
    .paper .small{font-size:10px;opacity:.7}

    .counter{position:absolute;right:12px;top:12px;font-family:"Press Start 2P"; font-size:12px;color:#ffe59a;text-shadow:0 1px 0 #000}

    .top-left{position:absolute;left:10px;top:10px;opacity:.8;font-size:12px}

    /* Inline frog positioning */
    .frog{
      position:absolute;
      left:8vw;
      bottom:24vh; /* находится на линии травы */
      height:min(38vh,36vw);
      filter:drop-shadow(0 8px 16px rgba(0,0,0,.25));
      image-rendering: pixelated;
      pointer-events:none;
      z-index:1; /* над канвасом */
    }
  </style>
</head>
<body>
  <script src="https://cdn.jsdelivr.net/npm/p5@1.9.0/lib/p5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js"></script>

  <div class="wrap">
    <div class="top-left">Доброе утро · пиксельная магия</div>
    <div id="counter" class="counter"></div>

    <!-- Inline SVG Frog (статичная) -->
    <svg id="frog" class="frog" viewBox="0 0 128 128" xmlns="http://www.w3.org/2000/svg" aria-label="Лягушка-волшебница">
      <defs>
        <style>
          .g0{fill:#2E8B57}.g1{fill:#6ECF8F}.eye{fill:#FFE59A}.ink{fill:#0F0F12}
          .hat{fill:#2E2A68}.gem{fill:#FFE59A}.wand{fill:#6B4F28}.spark{fill:#FFE59A}
        </style>
      </defs>
      <!-- body -->
      <rect class="g0" x="22" y="66" width="84" height="44" rx="4"/>
      <rect class="g1" x="38" y="78" width="52" height="24" rx="4"/>
      <!-- head -->
      <rect class="g0" x="34" y="44" width="60" height="28" rx="4"/>
      <!-- eyes -->
      <rect class="eye" x="38" y="36" width="14" height="14" rx="2"/>
      <rect class="eye" x="76" y="36" width="14" height="14" rx="2"/>
      <rect class="ink" x="44" y="42" width="4" height="4"/>
      <rect class="ink" x="82" y="42" width="4" height="4"/>
      <!-- mouth -->
      <rect class="ink" x="52" y="60" width="24" height="3" rx="1"/>
      <!-- hat -->
      <rect class="hat" x="30" y="32" width="68" height="6" rx="2"/>
      <rect class="hat" x="50" y="14" width="28" height="20" rx="2"/>
      <rect class="gem" x="58" y="18" width="12" height="8" rx="2"/>
      <!-- wand -->
      <rect class="wand" x="100" y="60" width="20" height="4" rx="2"/>
      <rect class="spark" x="118" y="56" width="6" height="12" rx="2"/>
    </svg>

    <!-- Prediction paper overlay -->
    <section id="paper" class="paper">
      <div class="paper-inner">
        <div class="paper-grid"></div>
        <div id="prediction" style="white-space:pre-wrap"></div>
        <div class="paper-footer">
          <span class="small">♡♡♡</span>
          <button id="btnClose" class="btn" style="background:#704214;color:#fff">Закрыть</button>
        </div>
      </div>
    </section>

    <!-- HUD: speech + actions -->
    <div class="hud">
      <div class="bubble">
        <h1>Доброе утро!✨</h1>
      </div>
      <div class="controls">
        <button id="btnGen" class="btn">Получить предсказание</button>
      </div>
      <div class="meta">Можно получить до трёх предсказаний в день</div>
    </div>
  </div>

  <script>
    // ===== DATA (предсказания оставляем как есть) =====
    const PREDS = [
      "Сегодня твоя улыбка привлечет внимание, и кто-то сделает тебе комплимент.",
      "В течение дня ты встретишь человека, который вдохновит тебя на новые идеи.",
      "Тебя ждет маленькое чудо — возможно, это будет неожиданное сообщение от старого друга.",
      "Дыхание 4–4–4. Замедлись — решения придут яснее.",
      "Сегодня ты найдешь время для себя и сделаешь что-то, что давно откладывал.",
      "У тебя появится возможность помочь кому-то, и это принесет радость как тебе, так и им.",
      "Тишина — тоже действие. Подожди полминуты перед ответом.",
      "Тебя ждет приятный сюрприз — возможно, это будет вкусный завтрак или неожиданный подарок.",
      "Отнесись к вниманию бережно: сфокусируйся на одном.",
      "Сегодня ты сможешь легко решить проблему, которая давно тебя беспокоила.",
      "Сегодня ты станешь свидетелем чего-то трогательного, что заставит тебя улыбнуться.",
      "Будь мягче к себе, маленький шаг — тоже прогресс."
    ];

    // ===== DAILY LIMIT (3/day) =====
    const $btn = document.getElementById('btnGen');
    const $paper = document.getElementById('paper');
    const $pred = document.getElementById('prediction');
    const $close = document.getElementById('btnClose');
    const $counter = document.getElementById('counter');

    function todayKey(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const da = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${da}`;
    }
    function getCount(){
      const key = 'du_count_'+todayKey();
      return parseInt(localStorage.getItem(key)||'0',10);
    }
    function incCount(){
      const key = 'du_count_'+todayKey();
      const n = getCount()+1; localStorage.setItem(key, String(n));
    }
    function refreshCounter(){
      const left = Math.max(0,3-getCount());
      $counter.textContent = `Сегодня: ${3-left}/3`;
      if(left<=0){
        $btn.disabled = true; $btn.textContent = 'Загляни завтра';
      } else {
        $btn.disabled = false; $btn.textContent = 'Получить предсказание';
      }
    }
    refreshCounter();

    // ===== MAGIC LOADING + SHOW PAPER =====
    let loading = false;
    $btn.addEventListener('click', ()=>{
      if(loading) return;
      if(getCount() >= 3){ refreshCounter(); return; }
      loading = true; startRitual(()=>{
        const text = pick(PREDS);
        $pred.textContent = '✦ '+text;
        openPaper(); incCount(); refreshCounter(); loading=false;
      });
    });
    $close.addEventListener('click', closePaper);

    function openPaper(){
      $paper.style.display = 'block';
      if(window.gsap){ gsap.fromTo('.paper-inner',{scale:0.9, opacity:0},{scale:1, opacity:1, duration:.35, ease:'power2.out'}); }
    }
    function closePaper(){
      if(!window.gsap){ $paper.style.display='none'; return; }
      gsap.to('.paper-inner',{scale:.95, opacity:0, duration:.25, ease:'power2.in', onComplete:()=>{$paper.style.display='none';}});
    }

    function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

    // ===== PIXEL MORNING (RGB) =====
    const REF = { top:'#FFD27A', mid:'#FFA63B', bot:'#FF8C2A', grassDark:'#4C6B3D', grassLight:'#678E4F' };
    const PIX = 8; // шаг сетки 8px

    // ===== P5 SCENE =====
    let sparkleTimer = 0, sparkles = [], stars = []; // background sparkles, mouse stars
    let swirl = []; // ritual particles

    new p5(p=>{
      let w,h; p.disableFriendlyErrors = true; p.pixelDensity(1);
      p.setup = ()=>{ w=p.windowWidth; h=p.windowHeight; p.createCanvas(w,h); p.noStroke(); p.frameRate(60); p.noSmooth(); };
      p.windowResized=()=>{ w=p.windowWidth; h=p.windowHeight; p.resizeCanvas(w,h); };

      p.draw = ()=>{
        drawMorningRGB(p);
        drawSparkles(p);
        drawMouseStars(p);
        drawRitual(p);
      };

      p.mouseMoved = ()=>{ // rainbow trail — крупнее
        for(let i=0;i<10;i++){
          stars.push({x:p.mouseX, y:p.mouseY, vx:(Math.random()-0.5)*1.6, vy:(Math.random()-0.5)*1.6-0.4, life:50+i*2, hue:(p.frameCount*2+i*12)%360});
        }
      };

      function drawMorningRGB(p){
        const skyH = Math.floor(h*0.75);
        // жёстко выставляем RGB, чтобы цвета были как в рефе
        p.colorMode(p.RGB,255,255,255,255);
        for(let y=0; y<skyH; y+=PIX){
          const t = y/skyH;
          const c = hexLerpRGB(REF.top, REF.mid, REF.bot, t);
          p.fill(c.r, c.g, c.b);
          p.rect(0, y, w, PIX);
        }
        // зелёная трава: тёмная полоса + «кисточки»
        const baseY = h*0.73;
        const gDark = hexToRgb(REF.grassDark), gLight = hexToRgb(REF.grassLight);
        p.fill(gDark.r, gDark.g, gDark.b); p.rect(0, baseY, w, h - baseY);
        p.fill(gLight.r, gLight.g, gLight.b);
        for(let x=0; x<w; x+=PIX){
          const hh = (Math.sin(x*0.03 + p.frameCount*0.02)*6 + 16);
          p.rect(x, baseY - hh, PIX, hh);
        }
      }

      function drawSparkles(p){
        // фоновое мерцание звёздочек (белые пиксели)
        sparkleTimer++;
        if(sparkleTimer%3===0 && sparkles.length<200){
          sparkles.push({x:Math.random()*w, y:Math.random()*h*0.55, a:0, r:Math.random()*2+1});
        }
        for(let s of sparkles){
          s.a += 0.03; const alpha = (Math.sin(s.a)*0.5+0.5)*90;
          p.fill(255,255,255,alpha);
          p.square(s.x|0, s.y|0, PIX/2);
        }
      }

      function drawMouseStars(p){
        const next=[]; for(let s of stars){
          s.x+=s.vx; s.y+=s.vy; s.vy+=0.008; s.life--; if(s.life>0){ next.push(s); }
          // радужные квадраты покрупнее
          p.colorMode(p.HSB,360,100,100,100);
          p.fill(s.hue, 80, 100, Math.min(100, s.life*3));
          p.square(s.x|0, s.y|0, PIX);
          p.colorMode(p.RGB,255,255,255,255);
        } stars=next;
      }

      function startSwirl(){
        swirl=[]; const cx=w*0.5, cy=h*0.5;
        for(let i=0;i<220;i++){
          const ang = i*(Math.PI*2/220);
          swirl.push({ang, rad:10+Math.random()*8, speed:0.06+Math.random()*0.04, life:120+Math.random()*40});
        }
      }

      function drawRitual(p){
        if(ritualActive){
          const cx=w*0.5, cy=h*0.5;
          p.colorMode(p.HSB,360,100,100,100);
          for(let s of swirl){
            s.ang += s.speed; s.rad += 0.7; s.life--;
            const x=cx + Math.cos(s.ang)*s.rad; const y=cy + Math.sin(s.ang)*s.rad*0.6;
            p.fill((p.frameCount*2)%360, 90, 100, 80);
            p.square(x|0,y|0,PIX/1.5);
          }
          p.colorMode(p.RGB,255,255,255,255);
          swirl = swirl.filter(s=>s.life>0);
          if(swirl.length===0){ ritualActive=false; if(typeof ritualDone==='function') ritualDone(); }
        }
      }

      // helpers for RGB
      function hexToRgb(hex){ const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); return m?{r:parseInt(m[1],16),g:parseInt(m[2],16),b:parseInt(m[3],16)}:{r:255,g:255,b:255}; }
      function hexLerpRGB(top,mid,bot,t){
        const seg = t<0.6 ? [top,mid,t/0.6] : [mid,bot,(t-0.6)/0.4];
        const a=hexToRgb(seg[0]), b=hexToRgb(seg[1]);
        const m=Math.max(0,Math.min(1,seg[2]));
        return { r:Math.round(a.r+(b.r-a.r)*m), g:Math.round(a.g+(b.g-a.g)*m), b:Math.round(a.b+(b.b-a.b)*m) };
      }

      // экспорт
      window.__startSwirl = startSwirl;
    });

    // ===== RITUAL LOADING =====
    let ritualActive=false, ritualDone=null;
    function startRitual(done){ ritualDone=done; ritualActive=true; window.__startSwirl && window.__startSwirl(); shimmerTitle(); }

    function shimmerTitle(){
      const el = document.querySelector('.bubble h1');
      if(!el || !window.gsap) return;
      gsap.fromTo(el,{opacity:0.6},{opacity:1, duration:1.2, yoyo:true, repeat:1, ease:'sine.inOut'});
    }
  </script>
</body>
</html>
